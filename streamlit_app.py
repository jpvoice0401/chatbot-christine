import streamlit as st
from openai import OpenAI
from datetime import datetime

# -----------------------------
# í˜ì´ì§€ ì„¤ì •
# -----------------------------
st.set_page_config(page_title="ì„¸í•œëŒ€ AIì½˜í…ì¸ ë””ìì¸í•™ê³¼ ì±—ë´‡", page_icon="ğŸ“")

# ì œëª© & ì„¤ëª…
st.title("ğŸ“ ì„¸í•œëŒ€í•™êµ AIì½˜í…ì¸ ë””ìì¸í•™ê³¼ ì±—ë´‡")
st.write(
    "ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹ ì €ëŠ” ì„¸í•œëŒ€ **AIì½˜í…ì¸ ë””ìì¸í•™ê³¼**ì— ëŒ€í•´ ê¶ê¸ˆí•œ ê²ƒì„ ë¬´ì—‡ì´ë“  ë‹µí•´ì£¼ëŠ” ì±—ë´‡ì´ì—ìš”.\n\n"
    "ë””ìì¸Â·ê²Œì„Â·AIì— ê´€ì‹¬ ìˆëŠ” í•™ìƒì´ë¼ë©´ ëˆ„êµ¬ë‚˜ í™˜ì˜í•©ë‹ˆë‹¤. "
    "í•™ê³¼ ì»¤ë¦¬í˜ëŸ¼, ì§„ë¡œ, ì…í•™ ì „í˜• ë“± ê¶ê¸ˆí•œ ì ì„ ììœ ë¡­ê²Œ ë¬¼ì–´ë³´ì„¸ìš”!"
)

# -----------------------------
# OpenAI API í‚¤ ì…ë ¥
# -----------------------------
openai_api_key = st.text_input(
    "OpenAI API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš” (ğŸ”’ ì…ë ¥ ë‚´ìš©ì€ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)",
    type="password",
)

if not openai_api_key:
    st.info("ê³„ì†í•˜ë ¤ë©´ OpenAI API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", icon="ğŸ—ï¸")
    st.stop()

# -----------------------------
# OpenAI í´ë¼ì´ì–¸íŠ¸ ìƒì„±
# -----------------------------
client = OpenAI(api_key=openai_api_key)

# -----------------------------
# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™” ë° ì‹œìŠ¤í…œ ë©”ì‹œì§€
# -----------------------------
if "messages" not in st.session_state:
    st.session_state.messages = [
        {
            "role": "system",
            "content": (
                "ë‹¹ì‹ ì€ ì„¸í•œëŒ€í•™êµ AIì½˜í…ì¸ ë””ìì¸í•™ê³¼ ì…í•™ í™ë³´ ì±—ë´‡ì…ë‹ˆë‹¤. "
                "ì˜ˆë¹„ ì‹ ì…ìƒì´ë‚˜ ë””ìì¸Â·ê²Œì„Â·AIì— ê´€ì‹¬ ìˆëŠ” í•™ìƒë“¤ì—ê²Œ ì¹œê·¼í•˜ê³  ì—´ì •ì ì¸ í†¤ìœ¼ë¡œ "
                "í•™ê³¼ ì»¤ë¦¬í˜ëŸ¼, êµìˆ˜ì§„, ì‹œì„¤, ì¡¸ì—… í›„ ì§„ë¡œ, ì…ì‹œ ì „í˜• ì •ë³´ë¥¼ ì œê³µí•˜ê³ , "
                "ì„¸í•œëŒ€í•™êµì— ì§€ì›í•˜ë„ë¡ ìì—°ìŠ¤ëŸ½ê²Œ ê¶Œìœ í•˜ì„¸ìš”. "
                "ë‹µë³€ì—ëŠ” êµ¬ì²´ì ì´ê³  ì‹¤ì œì ì¸ ì •ë³´(ì˜ˆ: ìº¡ìŠ¤í†¤ í”„ë¡œì íŠ¸ ì‚¬ë¡€, ì‚°ì—…ì²´ ì—°ê³„, êµë‚´ ì‹œì„¤ ëª…ì¹­)ë¥¼ í¬í•¨í•˜ê³ , "
                "í•™ìƒë“¤ì˜ í˜¸ê¸°ì‹¬ì„ ìê·¹í•˜ëŠ” ì§ˆë¬¸ìœ¼ë¡œ ëŒ€í™”ë¥¼ ì´ì–´ê°€ì„¸ìš”. "
                "ë‚ ì§œÂ·ë§ˆê°ì¼Â·í–‰ì‚¬ ì¼ì •ì€ ì‚¬ìš©ìì˜ ì§€ì—­(ëŒ€í•œë¯¼êµ­)ê³¼ í˜„ì¬ ë‚ ì§œ "
                f"{datetime.now().strftime('%Y-%m-%d')} ê¸°ì¤€ìœ¼ë¡œ ëª…í™•íˆ ì•ˆë‚´í•˜ì„¸ìš”."
            ),
        }
    ]

# -----------------------------
# ê¸°ì¡´ ëŒ€í™” ë‚´ì—­ ì¶œë ¥ (system ì œì™¸)
# -----------------------------
for message in st.session_state.messages[1:]:
    with st.chat_message(message["role"]):
        st.markdown(message["content"])

# -----------------------------
# ì‚¬ìš©ì ì…ë ¥ ì²˜ë¦¬
# -----------------------------
if prompt := st.chat_input("ë¬´ì—‡ì´ ê¶ê¸ˆí•œê°€ìš”?"):
    # ì‚¬ìš©ì ë©”ì‹œì§€ ì €ì¥ ë° ì¶œë ¥
    st.session_state.messages.append({"role": "user", "content": prompt})
    with st.chat_message("user"):
        st.markdown(prompt)

    # -----------------------------
    # OpenAI ì‘ë‹µ ìƒì„± (ìŠ¤íŠ¸ë¦¬ë°)
    # -----------------------------
    stream = client.chat.completions.create(
        model="gpt-4o-mini",  # ì„±ëŠ¥ ëŒ€ë¹„ ì†ë„ê°€ ë¹ ë¥´ê³  ì €ë ´í•œ ìµœì‹  ëª¨ë¸ ì‚¬ìš©
        temperature=0.8,       # ì¹œê·¼í•˜ê³  ì°½ì˜ì ì¸ í†¤ì„ ìœ„í•œ ê°’
        messages=st.session_state.messages,
        stream=True,
    )

    # ì‘ë‹µ ìŠ¤íŠ¸ë¦¬ë° ì¶œë ¥ & ì €ì¥
    with st.chat_message("assistant"):
        response = st.write_stream(stream)
    st.session_state.messages.append({"role": "assistant", "content": response})
